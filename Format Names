/* 
Purpose: This script is to create a new joint formatted name of Person1 (alumni) and spouse using formula's provided
This script consists of 2 different table
 1. First table: This table consists of information regarding Person1 and spouse (like: Prefix, person1 first name and last name and spouse first name and last name)
 2. Second Table: This table consists of the new formatted name without the education flag
 3. Third Table: This table consists of the new formatted name with the education flag

	SOURCE TABLES:
		contact base
		elcn_education
		elcn_personname
		elcn_personalrelationship
		elcn_formattedname

	HISTORY:
		11/09/2021	Dikshya	Pandey created
		
*/

SELECT DISTINCT 
pn.elcn_prefixidName as person1prefix
, cb.ContactId
, cb.FirstName as Person1FirstName
, cb.LastName as Person1LastName
--, cb.MiddleName as Person1MiddleName
, pr.elcn_Person1IdName
, pn2.elcn_prefixidName as person2prefix
, cb2.ContactId as spouseID
, cb2.FirstName  as Person2FirstName
--, cb2.MiddleName as Person2MiddleName
, cb2.LastName as Person2LastName
, pr.elcn_Person2IdName
, fn.elcn_formattedname
, fn.elcn_formattednameId
, fn.elcn_typeidName
into #fulltable
FROM ContactBase cb 
INNER JOIN elcn_personname pn on pn.elcn_personid = cb.ContactId and pn.elcn_nametypeName = 'primary'
LEFT JOIN elcn_personalrelationship pr on pr.elcn_Person1Id = cb.ContactId AND pr.statecode = 0 AND pr.statuscode =1
INNER JOIN elcn_formattedname fn on fn.elcn_personid = cb.ContactId
LEFT JOIN contactBase cb2 on pr.elcn_Person2Id = cb2.ContactId AND cb2.statecode = 0 AND cb2.statuscode =1
INNER JOIN elcn_personname pn2 on pr.elcn_Person2Id = pn2.elcn_personid and pn2.elcn_nametypeName = 'primary' 

WHERE 
elcn_typeidName IN ('Formal Joint Salutation')
AND pr.elcn_RelationshipType1IdName IN ('Spouse', 'Domestic Partner', 'Companion')
--AND lower(fn.elcn_formattedname) not like '%duplicate%' or lower(fn.elcn_formattedname) not like '% (test)'
AND cb.statecode = 0
AND cb.statuscode = 1
AND pn.statecode = 0 
AND pn.statuscode =1
AND fn.statecode = 0
AND fn.statuscode =1
AND pn2.statecode = 0 
AND pn2.statuscode =1
; 

--DROP TABLE IF EXISTS #fulltable


-- The code below is the new formatted name without the education flag

SELECT
 #fulltable.ContactId
, #fulltable.spouseID
, #fulltable.elcn_formattednameId
, #fulltable.person1prefix
, #fulltable.person2prefix
, #fulltable.Person1LastName
, #fulltable.Person2LastName
, #fulltable.Person1FirstName
, #fulltable.Person2FirstName
, #fulltable.elcn_formattedname
, #fulltable.elcn_typeidName


, CASE 
	   WHEN  #fulltable.Person1LastName = #fulltable.Person2LastName 
		AND #fulltable.person1prefix IS NOT NULL 
		AND #fulltable.person2prefix IS NOT NULL
			THEN  CONCAT(#fulltable.person1prefix,' ' , '&' , ' ',#fulltable.person2prefix, ' ', #fulltable.Person1LastName)
	   WHEN  #fulltable.Person1LastName <>  #fulltable.Person2LastName 
		AND #fulltable.person1prefix IS NOT NULL 
		AND #fulltable.person2prefix IS NOT NULL
			THEN CONCAT(#fulltable.person1prefix,' ', #fulltable.Person1LastName , ' ','&' , ' ', #fulltable.person2prefix, ' ',#fulltable.Person2LastName) 
	   WHEN #fulltable.person1prefix IS NULL 
		OR #fulltable.person2prefix IS NULL 
			THEN CONCAT (#fulltable.Person1FirstName,' ' ,'& ',' ',#fulltable.Person2FirstName )
	   END AS new_formattedname
into #newtb
FROM #fulltable ;

-- DROP TABLE IF EXISTS #newtb


-- SELECT * from #newtb

-- The code below is for creating the education flag for Person 1 and spouse and is the new formatted name with the education flag

SELECT DISTINCT ft.* 
, case when ed.elcn_PersonId IS NOT NULL then 1 else 0 end Person1flag
, case when ed2.elcn_PersonId IS NOT NULL then 1 else 0 end Spouseflag
, CASE 
		WHEN ed2.elcn_PersonId IS NOT NULL
		AND ed.elcn_PersonId IS NULL
		AND ft.person1prefix IS NOT NULL 
		AND ft.person2prefix IS NOT NULL
		AND ft.Person1LastName = ft.Person2LastName
			THEN  CONCAT(ft.person2prefix,' ' , '&' , ' ',ft.person1prefix, ' ', ft.Person2LastName)
		WHEN ed2.elcn_PersonId IS NOT NULL
		AND ed.elcn_PersonId IS NULL
		AND ft.person1prefix IS NOT NULL 
		AND ft.person2prefix IS NOT NULL
		AND  ft.Person1LastName <> ft.Person2LastName
			THEN CONCAT (ft.person2prefix,' ', ft.Person2LastName , ' ','&' , ' ', ft.person1prefix, ' ',ft.Person1LastName )
		WHEN ed2.elcn_PersonId IS NOT NULL
		AND ed.elcn_PersonId IS NULL
		AND ft.person1prefix IS  NULL 
	     OR ft.person2prefix IS NULL
			THEN CONCAT (ft.Person2FirstName,' ' ,'& ',' ',ft.Person1FirstName)
			ELSE ft.new_formattedname
	END AS FINAL_formattedname




from #newtb ft

LEFT JOIN elcn_education ed on ft.ContactId = ed.elcn_PersonId AND ed.elcn_InstitutionIdName = 'American University' AND ed.elcn_graduationstatusIdName = 'Completed' AND ed.statecode = 0 AND ed.statuscode = 1
LEFT JOIN elcn_education ed2 on ft.spouseID = ed2.elcn_PersonId AND ed2.elcn_InstitutionIdName = 'American University' AND ed2.elcn_graduationstatusIdName = 'Completed' AND ed2.statecode = 0 AND ed2.statuscode = 1
;
